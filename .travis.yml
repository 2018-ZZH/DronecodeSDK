language: cpp

matrix:
  fast_finish: true
  include:
    - os: linux
      dist: trusty
      sudo: false
      env: BUILD_TARGET=trusty_build
      compiler: gcc
    - os: linux
      dist: trusty
      sudo: false
      env: BUILD_TARGET=trusty_build
      compiler: gcc-5
    - os: linux
      dist: trusty
      sudo: false
      env: BUILD_TARGET=trusty_build
      compiler: clang
    - os: linux
      sudo: required
      services:
        - docker
      env: BUILD_TARGET=docker_build

addons:
  apt:
    packages:
    - libcurl4-openssl-dev

before_script:
- set -e
- if [[ "${BUILD_TARGET}" = "trusty_build" ]]; then
    mkdir -p ~/bin;
    wget -O ~/bin/astyle https://github.com/PX4/astyle/releases/download/2.05.1/astyle-linux;
    chmod +x ~/bin/astyle;
  fi
- if [[ "${BUILD_TARGET}" = "docker_build" ]]; then
    pip install --user awscli;
    $(aws ecr get-login --region eu-central-1);
    docker pull ${DOCKER_REPO};
  fi

script:
- if [[ "${BUILD_TARGET}" = "trusty_build" ]]; then
    make;
    make run_unit_tests;
    make fix_style;
  fi
- if [[ "${BUILD_TARGET}" = "docker_build" ]]; then
    docker run -it -v $TRAVIS_BUILD_DIR:/home/docker1000/src/DroneLink:rw ${DOCKER_REPO} make;
    docker run -it -v $TRAVIS_BUILD_DIR:/home/docker1000/src/DroneLink:rw ${DOCKER_REPO} make run_unit_tests;
    docker run -it -v $TRAVIS_BUILD_DIR:/home/docker1000/src/DroneLink:rw ${DOCKER_REPO} make fix_style;
  fi
